<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; }
        input, select { padding: 5px; margin: 5px; }
        .online { color: green; }
        .offline { color: red; }
        .message { margin: 5px 0; padding: 5px; background: #e9ecef; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Debug Tool</h1>
        
        <div class="section">
            <h3>Connection</h3>
            <label>User ID: 
                <select id="userId">
                    <option value="a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11">Alice (a0eebc99)</option>
                    <option value="b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a12">Bob (b0eebc99)</option>
                    <option value="c0eebc99-9c0b-4ef8-bb6d-6bb9bd380a13">Charlie (c0eebc99)</option>
                </select>
            </label>
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn">Disconnect</button>
            <span id="status" class="offline">Disconnected</span>
        </div>

        <div class="section">
            <h3>Send Message</h3>
            <label>Recipient: 
                <select id="recipientId">
                    <option value="a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11">Alice (a0eebc99)</option>
                    <option value="b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a12">Bob (b0eebc99)</option>
                    <option value="c0eebc99-9c0b-4ef8-bb6d-6bb9bd380a13">Charlie (c0eebc99)</option>
                </select>
            </label>
            <input type="text" id="messageInput" placeholder="Type your message..." style="width: 300px;">
            <button id="sendBtn">Send</button>
        </div>

        <div class="section">
            <h3>Debug Actions</h3>
            <button id="statusBtn">Log Connection Status</button>
            <button id="clearBtn">Clear Logs</button>
        </div>

        <div class="section">
            <h3>Activity Log</h3>
            <div id="log" class="log"></div>
        </div>

        <div class="section">
            <h3>Received Messages</h3>
            <div id="messages" class="log"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentSubscription = null;
        let currentUserId = null;

        const log = document.getElementById('log');
        const messages = document.getElementById('messages');
        const status = document.getElementById('status');

        function addLog(message) {
            const now = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${now}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${now}] ${message}`);
        }

        function addMessage(msg) {
            const now = new Date().toLocaleTimeString();
            messages.innerHTML += `<div class="message">[${now}] From: ${msg.senderId} | To: ${msg.recipientId} | ${msg.content}</div>`;
            messages.scrollTop = messages.scrollHeight;
        }

        function updateStatus(connected) {
            status.textContent = connected ? 'Connected' : 'Disconnected';
            status.className = connected ? 'online' : 'offline';
        }

        function connect() {
            const userId = document.getElementById('userId').value;
            currentUserId = userId;
            
            addLog(`üîå Connecting as user: ${userId}`);
            
            const socket = new SockJS('http://localhost:8080/api/collab/ws');
            stompClient = Stomp.over(socket);
            
            // Enable debug for development
            stompClient.debug = function(str) {
                addLog(`STOMP: ${str}`);
            };

            stompClient.connect(
                { userID: userId }, // Headers
                function(frame) {
                    addLog(`‚úÖ Connected successfully! Frame: ${frame}`);
                    updateStatus(true);
                    
                    // Subscribe to private messages
                    currentSubscription = stompClient.subscribe('/user/queue/messages', function(message) {
                        addLog(`üì® Raw message received: ${message.body}`);
                        try {
                            const chatMessage = JSON.parse(message.body);
                            addLog(`üì® Parsed message: ${JSON.stringify(chatMessage)}`);
                            addMessage(chatMessage);
                        } catch (e) {
                            addLog(`‚ùå Error parsing message: ${e.message}`);
                        }
                    });
                    
                    addLog(`üì± Subscribed to /user/queue/messages with subscription ID: ${currentSubscription.id}`);
                    
                    // Send connect message
                    stompClient.send('/app/chat.connect', {}, JSON.stringify({
                        userId: userId,
                        username: `User-${userId.substring(0, 8)}`
                    }));
                    addLog(`üì§ Sent connect message`);
                },
                function(error) {
                    addLog(`‚ùå Connection error: ${error}`);
                    updateStatus(false);
                    stompClient = null;
                }
            );
        }

        function disconnect() {
            if (stompClient !== null) {
                if (currentSubscription) {
                    currentSubscription.unsubscribe();
                    addLog(`üîÑ Unsubscribed from messages`);
                }
                stompClient.disconnect();
                stompClient = null;
                updateStatus(false);
                addLog(`üîå Disconnected`);
            }
        }

        function sendMessage() {
            const recipientId = document.getElementById('recipientId').value;
            const messageText = document.getElementById('messageInput').value.trim();
            
            if (!messageText) {
                addLog('‚ùå Please enter a message');
                return;
            }
            
            if (!stompClient || !stompClient.connected) {
                addLog('‚ùå Not connected to WebSocket');
                return;
            }
            
            if (currentUserId === recipientId) {
                addLog('‚ùå Cannot send message to yourself');
                return;
            }

            const message = {
                senderId: currentUserId,
                recipientId: recipientId,
                content: messageText,
                chatType: 'PRIVATE',
                type: 'TEXT'
            };

            addLog(`üì§ Sending message: ${JSON.stringify(message)}`);
            
            stompClient.send('/app/chat.sendMessage', { userID: currentUserId }, JSON.stringify(message));
            document.getElementById('messageInput').value = '';
            addLog(`‚úÖ Message sent to ${recipientId}`);
        }

        function logStatus() {
            const connected = stompClient && stompClient.connected;
            const hasSubscription = currentSubscription !== null;
            
            addLog(`üîç Debug Status:`);
            addLog(`  - Connected: ${connected}`);
            addLog(`  - Has Subscription: ${hasSubscription}`);
            addLog(`  - Current User: ${currentUserId}`);
            addLog(`  - Client exists: ${stompClient !== null}`);
            if (currentSubscription) {
                addLog(`  - Subscription ID: ${currentSubscription.id}`);
            }
        }

        function clearLogs() {
            log.innerHTML = '';
            messages.innerHTML = '';
        }

        // Event listeners
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('disconnectBtn').addEventListener('click', disconnect);
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('statusBtn').addEventListener('click', logStatus);
        document.getElementById('clearBtn').addEventListener('click', clearLogs);
        
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Initial log
        addLog('üöÄ Debug tool ready. Select a user and connect.');
    </script>
</body>
</html>
